<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .room-form {
            height: 100%;
            border: 1px solid #dee2e6;
            padding: 20px;
        }
        .room-table {
            height: 100%;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark fixed-top">
        <div class="container">
            <a href="admin-dashboard.html" class="navbar-brand">Megatower Hub
                <span class="text-secondary" style="font-size: 0.8em;">Admin Dashboard</span>
            </a>

            <button class="navbar-toggler" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#navmenu" 
            aria-controls="navmenu" 
            aria-expanded="false" 
            aria-label="Toggle navigation menu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navmenu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a href="#" class="nav-link text-light">Notifications</a>
                    </li>
                    <li class="nav-item">
                        <a href="admin-complaints.html" class="nav-link text-light">Complaints</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Request
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="admin-maintenance.html">Maintenance</a>
                            <a class="dropdown-item" href="admin-cleaning.html">Cleaning</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-light" href="#" id="roomsDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Rooms
                        </a>
                        <div class="dropdown-menu" aria-labelledby="roomsDropdown">
                            <a class="dropdown-item" href="admin-room-category.html">Room Category</a>
                            <a class="dropdown-item" href="admin-addRoom.html">Room Form</a>
                        </div>
                    </li>
                    <li class="nav-item">
                    <a href="user-management.html" class="nav-link text-light">Users</a>
                </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link text-light">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link text-light" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>   
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6" style="height: 100%;">
                <h2>Add Room</h2>
                <form id="addRoomForm" class="room-form">
                    <div class="mb-3">
                        <label for="room" class="form-label">Room</label>
                        <input type="text" class="form-control" id="room" required>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" required>
                            <!-- Category options will be dynamically populated here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="floor" class="form-label">Floor</label>
                        <input type="number" class="form-control" id="floor" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" required>
                            <option value="transient">Transient</option>
                            <option value="buy">Buy</option>
                            <option value="lease">Lease</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="price" required>
                    </div>
                    <div class="mb-3">
                        <label for="availability" class="form-label">Availability</label>
                        <select class="form-select" id="availability" required>
                            <option value="available">Available</option>
                            <option value="unavailable">Unavailable</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Room</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
            <div class="col-md-6" style="height: 100%;">
                <h2>Room List</h2>
                <table class="table room-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Category</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="roomTableBody">
                        <!-- Room list will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div class="modal fade" id="editRoomModal" tabindex="-1" aria-labelledby="editRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoomModalLabel">Edit Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRoomForm">
                        <div class="mb-3">
                            <label for="editRoom" class="form-label">Room</label>
                            <input type="text" class="form-control" id="editRoom" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCategory" class="form-label">Category</label>
                            <select class="form-select" id="editCategory" required>
                                <!-- Category options will be dynamically populated here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editFloor" class="form-label">Floor</label>
                            <input type="number" class="form-control" id="editFloor" required>
                        </div>
                        <div class="mb-3">
                            <label for="editType" class="form-label">Type</label>
                            <select class="form-select" id="editType" required>
                                <option value="transient">Transient</option>
                                <option value="buy">Buy</option>
                                <option value="lease">Lease</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="editPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAvailability" class="form-label">Availability</label>
                            <select class="form-select" id="editAvailability" required>
                                <option value="available">Available</option>
                                <option value="unavailable">Unavailable</option>
                            </select>
                        </div>
                        <input type="hidden" id="editRoomId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedRoom()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0w3oovf85ZTyZBfKapuZxx1i0OiGyRZ0",
            authDomain: "megatower-hub-ca285.firebaseapp.com",
            databaseURL: "https://megatower-hub-ca285-default-rtdb.firebaseio.com",
            projectId: "megatower-hub-ca285",
            storageBucket: "megatower-hub-ca285.appspot.com",
            messagingSenderId: "900973693171",
            appId: "1:900973693171:web:9062bf9b49221596294f86"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // References to Firebase services
        const database = firebase.database();

        // Room form and table body
        const roomForm = document.getElementById('addRoomForm');
        const roomTableBody = document.getElementById('roomTableBody');

        // Populate category dropdown with room categories
        const categoryDropdown = document.getElementById('category');
        const editCategoryDropdown = document.getElementById('editCategory');
        database.ref('room_category').on('value', function(snapshot) {
            categoryDropdown.innerHTML = '';
            editCategoryDropdown.innerHTML = '';
            snapshot.forEach(function(childSnapshot) {
                const data = childSnapshot.val();
                const categoryName = data.name;
                const option = document.createElement('option');
                option.text = categoryName;
                option.value = categoryName;
                categoryDropdown.appendChild(option);

                const editOption = document.createElement('option');
                editOption.text = categoryName;
                editOption.value = categoryName;
                editCategoryDropdown.appendChild(editOption);
            });
        });

        // Function to add a room
        roomForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get form values
            const room = document.getElementById('room').value;
            const category = document.getElementById('category').value;
            const floor = document.getElementById('floor').value;
            const type = document.getElementById('type').value;
            const price = document.getElementById('price').value;
            const availability = document.getElementById('availability').value;

            // Fetch category details from room_category node
            database.ref('room_category').orderByChild('name').equalTo(category).once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    const categoryData = childSnapshot.val();
                    const image = categoryData.image;
                    const amenities = categoryData.amenities;
                    const maxGuests = categoryData.maxGuests;

                    // Add room data to Firebase Realtime Database
                    const roomData = {
                        room: room,
                        category: category,
                        floor: floor,
                        type: type,
                        price: price,
                        availability: availability,
                        image: image,
                        amenities: amenities,
                        maxGuests: maxGuests
                    };
                    database.ref('rooms').push(roomData);
                });
            });

            roomForm.reset();
        });

        // Function to display rooms in the table
        database.ref('rooms').on('value', function(snapshot) {
            roomTableBody.innerHTML = '';
            let count = 1;

            snapshot.forEach(function(childSnapshot) {
                const data = childSnapshot.val();
                const key = childSnapshot.key;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${count++}</td>
                    <td>${data.category}</td>
                    <td>Room: ${data.room}<br>Type: ${data.type}<br>Floor: ${data.floor}<br>Price: ${data.price}</td>
                    <td><span class="badge ${data.availability === 'available' ? 'bg-success' : 'bg-danger'}">${data.availability}</span></td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm" onclick="editRoom('${key}', '${data.room}', '${data.category}', '${data.floor}', '${data.type}', '${data.price}', '${data.availability}')">Edit</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteRoom('${key}')">Delete</button>
                    </td>
                `;
                roomTableBody.appendChild(tr);
            });
        });

        // Function to edit room
        function editRoom(id, room, category, floor, type, price, availability) {
            document.getElementById('editRoom').value = room;
            document.getElementById('editCategory').value = category;
            document.getElementById('editFloor').value = floor;
            document.getElementById('editType').value = type;
            document.getElementById('editPrice').value = price;
            document.getElementById('editAvailability').value = availability;
            document.getElementById('editRoomId').value = id;
            // Open the Bootstrap modal using jQuery
            $('#editRoomModal').modal('show');
        }

        // Function to save edited room
        function saveEditedRoom() {
            const id = document.getElementById('editRoomId').value;
            const room = document.getElementById('editRoom').value;
            const category = document.getElementById('editCategory').value;
            const floor = document.getElementById('editFloor').value;
            const type = document.getElementById('editType').value;
            const price = document.getElementById('editPrice').value;
            const availability = document.getElementById('editAvailability').value;

            database.ref('rooms').child(id).update({
                room: room,
                category: category,
                floor: floor,
                type: type,
                price: price,
                availability: availability
            }).then(() => {
                $('#editRoomModal').modal('hide');
            }).catch(error => {
                console.error('Error updating room: ', error);
            });
        }

        // Function to delete room
        function deleteRoom(key) {
            if (confirm('Are you sure you want to delete this room?')) {
                database.ref('rooms').child(key).remove()
                    .then(() => {
                        console.log('Room deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting room: ', error);
                    });
            }
        }

        // Function to reset the form
        function resetForm() {
            roomForm.reset();
        }
    </script>

</body>
</html>
