<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.19.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>

  <!--Navbar-->
  <nav class="navbar navbar-expand-lg bg-success navbar-dark fixed-top">
    <div class="container">
      <a href="home-page.html" class="navbar-brand">MegaTower Hub</a>

      <button class="navbar-toggler" 
      type="button" 
      data-bs-toggle="collapse" 
      data-bs-target="#navmenu" 
      aria-controls="navmenu" 
      aria-expanded="false" 
      aria-label="Toggle navigation menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-light" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Notifications
            </a>
            <ul class="dropdown-menu" aria-labelledby="notificationsDropdown" id="notificationDropdownMenu">
              <!-- Notifications will be displayed here -->
            </ul>
          </li>
          <li class="nav-item">
            <a href="complain-page.html" class="nav-link text-light">Complaints</a>
          </li>
          <li class="nav-item">
            <a href="request-page.html" class="nav-link text-light">Request</a>
          </li>
          <li class="nav-item">
            <a href="payment-page.html" class="nav-link text-light">Payment</a>
          </li>
          <li class="nav-item">
            <a href="forum-page.html" class="nav-link text-light">Forum</a>
          </li>
          <li class="nav-item">
            <a href="#questions" class="nav-link text-light">FAQs</a>
          </li>
          <li class="nav-item">
            <a href="tenant-profile.html" class="nav-link text-light">Profile</a>
          </li>
          <li class="nav-item">
            <a href="javascript:void(0);" onclick="logout()" class="nav-link text-light">Logout</a>
          </li>
        </ul>
      </div>
    </div>   
  </nav>


  <div class="container mt-5">
    <div class="row">
      <!-- Request Form Column (80%) -->
      <div class="col-md-8 request-column">
        <div class="border p-4">
          <h2 class="mb-4">Submit Request</h2>
          <form id="requestForm">
            <div class="mb-3">
                <label for="requestType" class="form-label">Request Type</label>
                <select class="form-select" id="requestType" required>
                    <option value="maintenance">Maintenance</option>
                    <option value="cleaning">Cleaning</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="scheduleDate" class="form-label">Schedule Date</label>
                <input type="date" class="form-control" id="scheduleDate" required>
            </div>
            <div class="mb-3">
                <label for="scheduleTime" class="form-label">Schedule Time</label>
                <input type="time" class="form-control" id="scheduleTime" required>
            </div>
            <!-- Optional Media Upload Button with Icon -->
            <div class="mb-3">
                <label for="mediaUpload" class="form-label">Media Upload (Optional)</label>
                <div class="input-group">
                    <input type="file" class="form-control" id="mediaUpload">
                    <label class="input-group-text" for="mediaUpload">
                        <i class="bi bi-cloud-upload"></i>
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Submit Request</button>
            
            <!-- Emergency Maintenance Request Button -->
            <button type="button" class="btn btn-danger" id="emergencyBtn">Emergency Maintenance Request</button>
          </form>
        </div>
      </div>

      <!-- Feedback Form Column (20%) -->
      <div class="col-md-4 feedback-column" style="height: 100vh;">
        <div class="border p-4" style="height: 100%;">
          <h2 class="mb-4">Feedback</h2>
          <div id="feedbackBox" style="max-height: 100%; overflow-y: auto;">
            <!-- Feedback form elements here -->
          </div>
        </div>
      </div>
    </div>
  </div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.19.0/dist/js/bootstrap-icons.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyB0w3oovf85ZTyZBfKapuZxx1i0OiGyRZ0",
          authDomain: "megatower-hub-ca285.firebaseapp.com",
          databaseURL: "https://megatower-hub-ca285-default-rtdb.firebaseio.com",
          projectId: "megatower-hub-ca285",
          storageBucket: "megatower-hub-ca285.appspot.com",
          messagingSenderId: "900973693171",
          appId: "1:900973693171:web:9062bf9b49221596294f86"
        };

        firebase.initializeApp(firebaseConfig);

    const requestForm = document.getElementById('requestForm');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const feedbackBox = document.getElementById('feedbackBox');

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        const userUID = user.uid;

        // Fetch and display notifications for the authenticated user from requestsNotif
        const notificationsRef = firebase.database().ref(`users/${userUID}/requestsNotif`);

        notificationsRef.on('child_added', (snapshot) => {
          const notification = snapshot.val();
          const notificationItem = document.createElement('div');
          notificationItem.className = 'border p-3 my-3';

          const notificationMessage = notification.message;

          notificationItem.innerHTML = `
            ${notificationMessage}<br>
            <hr>
          `;

          feedbackBox.appendChild(notificationItem);
        });

        requestForm.addEventListener('change', () => {
          const requestType = document.getElementById('requestType').value;
          // Show or hide the emergency button based on the selected request type
          emergencyBtn.style.display = (requestType === 'maintenance') ? 'block' : 'none';
        });

        // Emergency Maintenance Request Button Click Event
        emergencyBtn.addEventListener('click', () => {
          // Show a confirmation prompt with a warning about the seriousness of the request
          const isEmergency = confirm("This is an emergency maintenance request. Are you sure?");
          
          if (isEmergency) {
            // Prompt for confirmation and proceed with the emergency request
            submitEmergencyRequest();
          } else {
            // Inform the user that the emergency request is canceled
            alert("Emergency request canceled. Thank you for your cooperation.");
          }
        });
      }

      // Function to submit an emergency maintenance request
      function submitEmergencyRequest() {
        // Construct the emergency request data
        const requestData = {
          description: "Emergency maintenance request",
          isEmergency: true, // Mark the request as an emergency
          // Add any other necessary data
        };

        // Submit the emergency request
        submitRequest('maintenanceRequests', requestData);
      }

      requestForm.addEventListener('submit', (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        const requestType = document.getElementById('requestType').value;
        const description = document.getElementById('description').value;
        const scheduleDate = document.getElementById('scheduleDate').value;
        const scheduleTime = document.getElementById('scheduleTime').value;

        const mediaUpload = document.getElementById('mediaUpload');
        const mediaFile = mediaUpload.files[0];

        const requestData = {
          description,
          scheduleDate,
          scheduleTime,
          // Add any other data you want to include
        };

        // Check the selected request type and submit to the corresponding collection
        if (requestType === 'maintenance') {
          submitRequest('maintenanceRequests', requestData, mediaFile);
        } else if (requestType === 'cleaning') {
          submitRequest('cleaningRequests', requestData, mediaFile);
        }
      });

      // Function to submit request data to the specified collection
      function submitRequest(collection, requestData, mediaFile) {
        const user = firebase.auth().currentUser;
        if (user) {
          const userUID = user.uid;

          // Add user-specific information to the request data
          requestData.userID = userUID;
          requestData.submittedAt = firebase.database.ServerValue.TIMESTAMP;

          // Check if a file is selected for upload
          if (mediaFile) {
            const storageRef = firebase.storage().ref();
            // Define the folder based on the request type
            const folder = collection === 'maintenanceRequests' ? 'maintenance' : 'cleaning';
            const fileName = new Date().getTime() + '_' + mediaFile.name; // Unique file name
            const fileRef = storageRef.child(`${folder}/${fileName}`);

            fileRef.put(mediaFile)
              .then((snapshot) => {
                // File uploaded successfully, get download URL
                return snapshot.ref.getDownloadURL();
              })
              .then((downloadURL) => {
                // Add the download URL to the request data
                requestData.mediaURL = downloadURL;

                // Add the request data to the specified collection
                firebase.database().ref(collection).push(requestData)
                  .then(() => {
                    alert('Request submitted successfully!');
                    // You can add additional logic or UI updates as needed
                    requestForm.reset();
                  })
                  .catch((error) => {
                    console.error('Error submitting request:', error);
                    alert('Error submitting request. Please try again.');
                  });
              })
              .catch((error) => {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
              });
          } else {
            // No file selected, submit request without media URL
            firebase.database().ref(collection).push(requestData)
              .then(() => {
                alert('Request submitted successfully!');
                // You can add additional logic or UI updates as needed
                requestForm.reset();
              })
              .catch((error) => {
                console.error('Error submitting request:', error);
                alert('Error submitting request. Please try again.');
              });
          }
        }
      }
    });

    // Function to display feedback
    function displayFeedback(feedback) {
      const feedbackBox = document.getElementById('feedbackBox');
      feedbackBox.innerHTML = ''; // Clear the existing content

      // Sort feedback based on timestamp in ascending order
      const sortedFeedback = feedback.sort((a, b) => a.timestamp - b.timestamp);

      // Reverse the order to display from bottom to top
      sortedFeedback.reverse();

      sortedFeedback.forEach(item => {
        const feedbackItem = document.createElement('div');
        feedbackItem.className = 'mb-3';
        feedbackItem.innerHTML = `
            <p>${item.message} - ${formatTimestamp(item.timestamp)}</p>
            <hr>
        `;
        feedbackBox.appendChild(feedbackItem);
      });
    }

    // Firebase listener for feedback
    const feedbackRef = firebase.database().ref('feedback');
    feedbackRef.on('value', (snapshot) => {
      const feedbackData = snapshot.val() || [];
      displayFeedback(Object.values(feedbackData));
    });

    </script>
</body>
</html>
