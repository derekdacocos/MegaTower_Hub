<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="x-icon" href="src/megatower-hub-iconx.png">
    <title>Request Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.19.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" />
    <style>
      .navbar {
          background-color: #ffcb72 !important; /* Background color */
      }
    </style>
    <!-- Start of Async Drift Code -->
  <script>
    "use strict";
    
    !function() {
      var t = window.driftt = window.drift = window.driftt || [];
      if (!t.init) {
        if (t.invoked) return void (window.console && console.error && console.error("Drift snippet included twice."));
        t.invoked = !0, t.methods = [ "identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on" ], 
        t.factory = function(e) {
          return function() {
            var n = Array.prototype.slice.call(arguments);
            return n.unshift(e), t.push(n), t;
          };
        }, t.methods.forEach(function(e) {
          t[e] = t.factory(e);
        }), t.load = function(t) {
          var e = 3e5, n = Math.ceil(new Date() / e) * e, o = document.createElement("script");
          o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js";
          var i = document.getElementsByTagName("script")[0];
          i.parentNode.insertBefore(o, i);
        };
      }
    }();
    drift.SNIPPET_VERSION = '0.3.1';
    drift.load('kin4c3m7twpw');
    </script>
    <!-- End of Async Drift Code -->
</head>
<body>

  <!--Navbar-->
  <nav class="navbar navbar-expand-lg bg-success navbar-dark fixed-top">
    <div class="container">
      <a href="home-page.html" class="navbar-brand">
        <img src="src/megatower-hub-icon.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top me-2">
        MegaTower Hub
      </a>

        <button class="navbar-toggler" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#navmenu" 
            aria-controls="navmenu" 
            aria-expanded="false" 
            aria-label="Toggle navigation menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navmenu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                  <button type="button" class="nav-link text-light btn" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    Notifications <span id="unreadCountBadge" class="badge bg-danger">0</span>
                  </button>
                </li>
                <li class="nav-item">
                    <a href="complain-page.html" class="nav-link text-light">Complaints</a>
                </li>
                <li class="nav-item">
                    <a href="request-page.html" class="nav-link text-light">Request</a>
                </li>
                <li class="nav-item">
                    <a href="payment-page.html" class="nav-link text-light">Payment</a>
                </li>
                <li class="nav-item">
                    <a href="forum-page.html" class="nav-link text-light">Forum</a>
                </li>
                <li class="nav-item">
                    <a href="tenant-profile.html" class="nav-link text-light">Profile</a>
                </li>
                <li class="nav-item">
                    <a href="javascript:void(0);" onclick="logout()" class="nav-link text-light">Logout</a>
                </li>
            </ul>
        </div>
    </div>   
  </nav>

  <!-- Notifications Modal -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Sample notification content -->
          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-success">Welcome, Tenant!</h6>
            <p class="mb-0">This is the content of the first notification. You can provide more details here.</p>
          </div>

          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-warning">Maintenance Request</h6>
            <p class="mb-0">The maintenance request you submitted on 12/9/2023, 8:46:24 AM has been resolved.</p>
          </div>

          <!-- Add more notifications as needed -->
        </div>
      </div>
    </div>
  </div>

  <!-- Spinner container -->
  <div id="logoutSpinnerContainer" class="position-fixed top-50 start-50 translate-middle" style="display: none;">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-5">
    <div class="row">
      <!-- Request Form Column (80%) -->
      <div class="col-md-8 request-column">
        <div class="border p-4">
          <h2 class="mb-4">Submit Request</h2>
          <form id="requestForm">
            <div class="mb-3">
                <label for="requestType" class="form-label">Request Type</label>
                <select class="form-select" id="requestType" required>
                    <option value="maintenance">Maintenance</option>
                    <option value="cleaning">Cleaning</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="scheduleDate" class="form-label">Schedule Date</label>
                <input type="date" class="form-control" id="scheduleDate" required>
            </div>
            <div class="mb-3">
                <label for="scheduleTime" class="form-label">Schedule Time</label>
                <input type="time" class="form-control" id="scheduleTime" required>
            </div>
            <!-- Optional Media Upload Button with Icon -->
            <div class="mb-3">
                <label for="mediaUpload" class="form-label">Media Upload (Optional)</label>
                <div class="input-group">
                    <input type="file" class="form-control" id="mediaUpload">
                    <label class="input-group-text" for="mediaUpload">
                        <i class="bi bi-cloud-upload"></i>
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Submit Request</button>
            
            <!-- Emergency Maintenance Request Button -->
            <button type="button" class="btn btn-danger" id="emergencyBtn">Emergency Maintenance Request</button>
          </form>
        </div>
      </div>

      <!-- Feedback Form Column (20%) -->
      <div class="col-md-4 feedback-column" style="height: 100vh;">
        <div class="border p-4" style="height: 100%;">
          <h2 class="mb-4">Feedback</h2>
          <div id="feedbackBox" style="max-height: 100%; overflow-y: auto;">
            <!-- Feedback form elements here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Emergency Maintenance Request Modal -->
  <div class="modal fade" id="emergencyModal" tabindex="-1" aria-labelledby="emergencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="emergencyModalLabel">Emergency Maintenance Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Important:</strong> Misuse of the emergency feature can result in service fees and potential suspension of using emergency button.</p>
          <p><strong>Rules for Emergencies:</strong></p>
          <ul>
            <li>Use this feature only for genuine emergencies.</li>
            <li>Non-emergency use may result in penalties.</li>
            <li>Ensure all information provided is accurate.</li>
          </ul>
          <div class="mb-3">
            <label><strong>Please select the type of maintenance emergency:</strong></label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="waterLeak">
              <label class="form-check-label" for="waterLeak">
                Severe Water Leak/Flood
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="powerOutage">
              <label class="form-check-label" for="powerOutage">
                Complete Power Outage (within unit)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="structuralDamage">
              <label class="form-check-label" for="structuralDamage">
                Significant Structural Damage (posing immediate risk)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="elevatorMalfunction">
              <label class="form-check-label" for="elevatorMalfunction">
                Elevator Malfunction (trapping occupants)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="plumbingIssues">
              <label class="form-check-label" for="plumbingIssues">
                Major Plumbing Issues (e.g., broken pipe causing flooding)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="otherIssue">
              <label class="form-check-label" for="otherIssue">
                Other Immediate Maintenance Issue:
              </label>
              <input type="text" class="form-control mt-1" id="otherIssueDescription" placeholder="Describe the issue">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitEmergencyRequest">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="confirmationModalLabel">Confirm Emergency Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to submit this emergency request? Once submitted, it cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmEmergencyRequest">Confirm</button>
        </div>
      </div>
    </div>
  </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.19.0/dist/js/bootstrap-icons.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

    <script src="script.js"></script>

    <script>
    const requestForm = document.getElementById('requestForm');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const feedbackBox = document.getElementById('feedbackBox');

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        const userUID = user.uid;

        // Fetch and display notifications for the authenticated user from requestsNotif
        const notificationsRef = firebase.database().ref(`users/${userUID}/requestsNotif`);

        notificationsRef.on('child_added', (snapshot) => {
          const notification = snapshot.val();
          const notificationItem = document.createElement('div');
          notificationItem.className = 'border p-3 my-3';

          const notificationMessage = notification.message;

          notificationItem.innerHTML = `
            ${notificationMessage}<br>
            <small>${new Date(notification.dateTime).toLocaleString()}</small><br>
            <hr>
          `;

          feedbackBox.appendChild(notificationItem);
        });

        // Check if the user has a penaltyUntil date in the users node
        const userRef = firebase.database().ref(`users/${userUID}`);
        userRef.once('value', (snapshot) => {
          const userData = snapshot.val();
          if (userData && userData.penaltyUntil) {
            const penaltyUntil = userData.penaltyUntil;
            const currentDate = new Date().getTime();
            if (penaltyUntil > currentDate) {
              // User has a penalty, disable the emergency button and show a message
              emergencyBtn.disabled = true;
              const formattedDate = new Date(penaltyUntil).toLocaleString();
              const penaltyMessage = `A penalty has been applied to your account for misusing the emergency maintenance request feature. You will not be able to submit emergency maintenance requests until ${formattedDate}.`;
              alert(penaltyMessage); // You can customize this message as per your UI design
            }
          }
        });

        requestForm.addEventListener('change', () => {
          const requestType = document.getElementById('requestType').value;
          // Show or hide the emergency button based on the selected request type
          emergencyBtn.style.display = (requestType === 'maintenance') ? 'block' : 'none';
        });
      }
    });

      // Function to submit an emergency maintenance request
      function submitEmergencyRequest() {
        // Construct the emergency request data
        const requestData = {
          description: "Emergency maintenance request",
          isEmergency: true, // Mark the request as an emergency
          // Add any other necessary data
        };

        // Submit the emergency request
        submitRequest('maintenanceRequests', requestData);
      }

      requestForm.addEventListener('submit', (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        const requestType = document.getElementById('requestType').value;
        const description = document.getElementById('description').value;
        const scheduleDate = document.getElementById('scheduleDate').value;
        const scheduleTime = document.getElementById('scheduleTime').value;

        const mediaUpload = document.getElementById('mediaUpload');
        const mediaFile = mediaUpload.files[0];

        const requestData = {
          description,
          scheduleDate,
          scheduleTime,
          // Add any other data you want to include
        };

        // Check the selected request type and submit to the corresponding collection
        if (requestType === 'maintenance') {
          submitRequest('maintenanceRequests', requestData, mediaFile);
        } else if (requestType === 'cleaning') {
          submitRequest('cleaningRequests', requestData, mediaFile);
        }
      });

      // Function to submit request data to the specified collection and push a notification to admin
function submitRequest(collection, requestData, mediaFile) {
  const user = firebase.auth().currentUser;
  if (user) {
    const userUID = user.uid;

    // Add user-specific information to the request data
    requestData.userID = userUID;
    requestData.submittedAt = firebase.database.ServerValue.TIMESTAMP;

    // Fetch the user's fullName
    const userRef = firebase.database().ref(`users/${userUID}/fullName`);
    userRef.once('value', (snapshot) => {
      const fullName = snapshot.val();

      // Construct the admin notification message with fullName
      const adminNotificationMessage = `New ${collection.replace('Requests', '')} request submitted by ${fullName}. Description: ${requestData.description}`;

      // Check if a file is selected for upload
      if (mediaFile) {
        const storageRef = firebase.storage().ref();
        const folder = collection === 'maintenanceRequests' ? 'maintenance' : 'cleaning';
        const fileName = new Date().getTime() + '_' + mediaFile.name;
        const fileRef = storageRef.child(`${folder}/${fileName}`);

        fileRef.put(mediaFile)
          .then((snapshot) => {
            return snapshot.ref.getDownloadURL();
          })
          .then((downloadURL) => {
            requestData.mediaURL = downloadURL;

            // Push the notification to the adminNotifications node
            const adminNotification = {
              type: collection.replace('Requests', ''),
              message: adminNotificationMessage,
              isRead: false,
              submittedAt: firebase.database.ServerValue.TIMESTAMP
            };

            return Promise.all([
              firebase.database().ref(collection).push(requestData),
              firebase.database().ref('adminNotifications').push(adminNotification)
            ]);
          })
          .then(() => {
            alert('Request submitted successfully!');
            requestForm.reset();
          })
          .catch((error) => {
            console.error('Error:', error);
            alert('Error submitting request. Please try again.');
          });
      } else {
        // No file selected, submit request without media URL
        // Push the notification to the adminNotifications node
        const adminNotification = {
          type: collection.replace('Requests', ''),
          message: adminNotificationMessage,
          isRead: false,
          submittedAt: firebase.database.ServerValue.TIMESTAMP
        };

        Promise.all([
          firebase.database().ref(collection).push(requestData),
          firebase.database().ref('adminNotifications').push(adminNotification)
        ])
        .then(() => {
          alert('Request submitted successfully!');
          requestForm.reset();
        })
        .catch((error) => {
          console.error('Error submitting request:', error);
          alert('Error submitting request. Please try again.');
        });
      }
    });
  }
}

    // Function to display feedback in descending order by dateTime
    function displayFeedback(feedback) {
      const feedbackBox = document.getElementById('feedbackBox');
      feedbackBox.innerHTML = ''; // Clear existing feedback

      // Convert feedback object to an array and sort by dateTime in descending order
      const sortedFeedback = Object.values(feedback).sort((a, b) => b.dateTime - a.dateTime);

      sortedFeedback.forEach(item => {
        const feedbackItem = document.createElement('div');
        feedbackItem.className = 'mb-3';
        feedbackItem.innerHTML = `
            <p>${item.message} - ${formatTimestamp(item.dateTime)}</p>
            <hr>
        `;
        feedbackBox.appendChild(feedbackItem);
      });
    }

    // Function to format timestamp into a readable date string
    function formatTimestamp(timestamp) {
      // Create a new date object from the timestamp
      const date = new Date(timestamp);
      // Format the date into a readable string
      return date.toLocaleString(); // Example output: "3/15/2024, 7:24:49 AM"
    }

    // Firebase listener for feedback, assuming feedback data structure matches the given example
    const feedbackRef = firebase.database().ref('feedback');
    feedbackRef.on('value', (snapshot) => {
      const feedbackData = snapshot.val() || [];
      displayFeedback(feedbackData);
    });

    // Emergency Maintenance Request Button Click Event
    emergencyBtn.addEventListener('click', () => {
      // Show the emergency modal
      const emergencyModal = new bootstrap.Modal(document.getElementById('emergencyModal'), {
        keyboard: false
      });
      emergencyModal.show();
    });

    // Emergency Request Submission
    document.getElementById('submitEmergencyRequest').addEventListener('click', () => {
  // Gather selected emergency types
  const selectedEmergencies = [];
  if (document.getElementById('waterLeak').checked) selectedEmergencies.push('Severe Water Leak/Flood');
  if (document.getElementById('powerOutage').checked) selectedEmergencies.push('Complete Power Outage (within unit)');
  if (document.getElementById('structuralDamage').checked) selectedEmergencies.push('Significant Structural Damage (posing immediate risk)');
  if (document.getElementById('elevatorMalfunction').checked) selectedEmergencies.push('Elevator Malfunction (trapping occupants)');
  if (document.getElementById('plumbingIssues').checked) selectedEmergencies.push('Major Plumbing Issues (e.g., broken pipe causing flooding)');
  
  const otherIssueDescription = document.getElementById('otherIssueDescription').value;
  if (document.getElementById('otherIssue').checked && otherIssueDescription) {
    selectedEmergencies.push(`Other: ${otherIssueDescription}`);
  }

  if (selectedEmergencies.length === 0) {
    alert('Please select at least one emergency type.');
    return;
  }

  // Show the confirmation modal
  const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'), {
    keyboard: false
  });
  confirmationModal.show();

  // Handle confirmation
  document.getElementById('confirmEmergencyRequest').addEventListener('click', () => {
    confirmationModal.hide();

    // Construct the emergency request data
    const requestData = {
      description: selectedEmergencies.join(', '),
      isEmergency: true,
      submittedAt: firebase.database.ServerValue.TIMESTAMP,
      userID: firebase.auth().currentUser.uid,
    };

    // Submit the emergency request
    submitRequest('maintenanceRequests', requestData);
  }, { once: true }); // { once: true } ensures the event listener is invoked only once
});

    </script>

    <script>
      function logout() {
          // Show the spinner container
          document.getElementById('logoutSpinnerContainer').style.display = 'block';

          // Disable the logout link to prevent multiple clicks
          document.querySelector('.nav-link.text-light').setAttribute('disabled', 'disabled');
          
          firebase.auth().signOut().then(function() {
              // Sign-out successful, redirect to index.html
              window.location.href = 'index.html';
          }).catch(function(error) {
              // An error happened.
              console.error("Logout Error: ", error);
              // If there's an error, reset the UI elements
              document.getElementById('logoutSpinnerContainer').style.display = 'none';
              document.querySelector('.nav-link.text-light').removeAttribute('disabled');
          });
      }
    </script>
</body>
</html>
