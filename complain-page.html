<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complaint Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-success navbar-dark fixed-top">
    <div class="container">
      <a href="home-page.html" class="navbar-brand">MegaTower Hub</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu"
        aria-controls="navmenu" aria-expanded="false" aria-label="Toggle navigation menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-light" href="#" id="notificationsDropdown" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              Notifications
            </a>
            <ul class="dropdown-menu" aria-labelledby="notificationsDropdown" id="notificationDropdownMenu">
              <!-- Notifications will be displayed here -->
            </ul>
          </li>
          <li class="nav-item">
            <a href="complain-page.html" class="nav-link text-light">Complaints</a>
          </li>
          <li class="nav-item">
            <a href="request-page.html" class="nav-link text-light">Request</a>
          </li>
          <li class="nav-item">
            <a href="payment-page.html" class="nav-link text-light">Payment</a>
          </li>
          <li class="nav-item">
            <a href="forum-page.html" class="nav-link text-light">Forum</a>
          </li>
          <li class="nav-item">
            <a href="#questions" class="nav-link text-light">FAQs</a>
          </li>
          <li class="nav-item">
            <a href="tenant-profile.html" class="nav-link text-light">Profile</a>
          </li>
          <li class="nav-item">
            <a href="javascript:void(0);" onclick="logout()" class="nav-link text-light">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row">
      <!-- Left column for the complaint form (80%) -->
      <div class="col-md-8">
        <div class="border p-4 rounded bg-light">
          <h2>Complaint Form</h2>
          <form id="complaintForm">
            <div class="form-group">
              <label for="name">Name:</label>
              <input type="text" class="form-control" id="name" required>
            </div>            
            <div class="form-group">
              <label for="description">Description:</label>
              <textarea class="form-control mb-3" id="description" rows="4" required></textarea>
            </div>            
            <div class="form-group mb-3">
              <button type="button" class="btn btn-primary" onclick="submitComplaint()">Submit</button>
            </div>
          </form>                 
        </div>
      </div>

      <!-- Right column for feedback (20%) -->
      <div class="col-md-4">
        <div class="border p-4 rounded bg-light">
          <h2>Feedback</h2>
          <div id="feedbackBox">
            <!-- Feedback will be displayed here -->
            <!-- Add these elements in your HTML file with corresponding IDs -->
            <p id="fullName"></p>
            <p id="email"></p>
            <p id="phoneNumber"></p>
            <p id="dateOfBirth"></p>
            <p id="role"></p>
            <p id="unitNumber"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>

  <script>
    // Initialize Firebase
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB0w3oovf85ZTyZBfKapuZxx1i0OiGyRZ0",
      authDomain: "megatower-hub-ca285.firebaseapp.com",
      databaseURL: "https://megatower-hub-ca285-default-rtdb.firebaseio.com",
      projectId: "megatower-hub-ca285",
      storageBucket: "megatower-hub-ca285.appspot.com",
      messagingSenderId: "900973693171",
      appId: "1:900973693171:web:9062bf9b49221596294f86"
    };

    firebase.initializeApp(firebaseConfig);

    // Firebase Realtime Database
    const database = firebase.database();
    const auth = firebase.auth();

    // Function to get the current user ID
    function getUserId() {
      const user = firebase.auth().currentUser;
      console.log('Current User:', user);
      return user ? user.uid : null;
    }

    function submitComplaint() {
      const userID = getUserId();
      if (!userID) {
        alert("User ID not available. Please log in.");
        return;
      }

      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value; // Changed from 'complaintMessage' to 'description'

      // Validate form fields
      if (name.trim() === '' || description.trim() === '') {
        alert('Please fill out all required fields.');
        return; // Prevent further execution
      }

      // Get the current date and time in milliseconds
      const submittedAt = Date.now();

      // Push data to Firebase Realtime Database under complaints node
      database.ref('complaints').push({
        userID: userID,
        name: name,
        description: description, // Changed from 'complaintMessage' to 'description'
        submittedAt: submittedAt,
        resolved: false // Initially, the complaint is not resolved
      })
      .then(() => {
        // Clear the form after submission
        document.getElementById('complaintForm').reset();

        // Push data to Firebase Realtime Database under adminNotifications node
        database.ref('adminNotifications').push({
          type: 'Complaint',
          message: `${name} submitted a complaint.`,
          submittedAt: submittedAt,
          isRead: false // Initially, the notification is unread
        });
        
        alert("Complaint submitted successfully!");
      })
      .catch((error) => {
        console.error(error.message);
        alert("Error submitting complaint. Please try again.");
      });
    }

    // Check if the user is authenticated on page load
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in
        console.log("User is signed in:", user.uid);

        // Check if the authenticated user is in the 'users' collection
        database.ref('users/' + user.uid).once('value')
          .then(userSnapshot => {
            if (userSnapshot.exists()) {
              // User is in the 'users' collection
              console.log("User exists in 'users' collection.");

              // Display notifications for the authenticated user
              displayNotificationsForUser(user.uid);
            } else {
              // User is not in the 'users' collection
              console.log("User does not exist in 'users' collection.");
              alert("User not authorized. Please sign in with an authorized account.");
              // Redirect to the sign-in page or perform any other necessary action
            }
          })
          .catch(error => {
            console.error("Error checking user:", error);
          });
      } else {
        // No user is signed in
        console.log("No user is signed in.");
        // Redirect to the sign-in page or perform any other necessary action
      }
    });

   // Fetch and display notifications for the authenticated user
      function displayNotificationsForUser(userID) {
        const notificationsBox = document.getElementById('feedbackBox');
        notificationsBox.innerHTML = "";

        // Fetch notifications from the 'complaintNotifs' node under the user's ID
        database.ref('users/' + userID + '/complaintNotifs').orderByChild('dateTime').once('value')
            .then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    const notification = childSnapshot.val();

                    // Create HTML elements for each notification
                    const notificationDiv = document.createElement('div');
                    notificationDiv.innerHTML = `
                        <p>${notification.message}</p>
                        <small>${new Date(notification.dateTime).toLocaleString()}</small><br>
                        <hr>
                    `;

                    // Append the item to the box
                    notificationsBox.appendChild(notificationDiv);
                });
            })
            .catch(error => {
                console.error("Error retrieving notifications:", error);
            });
    }

    function validateForm() {
      const name = document.getElementById('name').value;
      const complaintMessage = document.getElementById('complaintMessage').value;
      
      if (name.trim() === '' || complaintMessage.trim() === '') {
        alert('Please fill out all required fields.');
        return false; // Prevent form submission
      }
      
      // If validation passes, allow form submission
      return true;
    }
  </script>
</body>

</html>
