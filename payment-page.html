<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="x-icon" href="src/megatower-hub-iconx.png">
    <title>Payment Options</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" />
    <link rel="stylesheet" href="styles.css">
    <style>
        .card {
            border: 1px solid #dee2e6; /* Aligning borders */
            border-radius: 10px; /* Rounded corners */
            margin-bottom: 20px; /* Spacing between cards */
        }

        .card-img-top {
            max-height: 100px; /* Limiting image height */
            object-fit: contain; /* Scaling images */
        }

        .card-body {
            text-align: center; /* Centering text */
        }

        .navbar {
            background-color: #ffcb72 !important; /* Background color */
        }
    </style>

    <!-- Start of Async Drift Code -->
    <script>
      "use strict";
      
      !function() {
        var t = window.driftt = window.drift = window.driftt || [];
        if (!t.init) {
          if (t.invoked) return void (window.console && console.error && console.error("Drift snippet included twice."));
          t.invoked = !0, t.methods = [ "identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on" ], 
          t.factory = function(e) {
            return function() {
              var n = Array.prototype.slice.call(arguments);
              return n.unshift(e), t.push(n), t;
            };
          }, t.methods.forEach(function(e) {
            t[e] = t.factory(e);
          }), t.load = function(t) {
            var e = 3e5, n = Math.ceil(new Date() / e) * e, o = document.createElement("script");
            o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js";
            var i = document.getElementsByTagName("script")[0];
            i.parentNode.insertBefore(o, i);
          };
        }
      }();
      drift.SNIPPET_VERSION = '0.3.1';
      drift.load('kin4c3m7twpw');
    </script>
    <!-- End of Async Drift Code -->

</head>
<body>

  <!--Navbar-->
  <nav class="navbar navbar-expand-lg bg-success navbar-dark fixed-top">
    <div class="container">
        <a href="home-page.html" class="navbar-brand">
          <img src="src/megatower-hub-icon.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top me-2">
          MegaTower Hub
        </a>

        <button class="navbar-toggler" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#navmenu" 
            aria-controls="navmenu" 
            aria-expanded="false" 
            aria-label="Toggle navigation menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navmenu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                  <button type="button" class="nav-link text-light btn" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    Notifications <span id="unreadCountBadge" class="badge bg-danger">0</span>
                  </button>
                </li>
                <li class="nav-item">
                    <a href="complain-page.html" class="nav-link text-light">Complaints</a>
                </li>
                <li class="nav-item">
                    <a href="request-page.html" class="nav-link text-light">Request</a>
                </li>
                <li class="nav-item">
                    <a href="payment-page.html" class="nav-link text-light">Payment</a>
                </li>
                <li class="nav-item">
                    <a href="forum-page.html" class="nav-link text-light">Forum</a>
                </li>
                <li class="nav-item">
                    <a href="tenant-profile.html" class="nav-link text-light">Profile</a>
                </li>
                <li class="nav-item">
                    <a href="javascript:void(0);" onclick="logout()" class="nav-link text-light">Logout</a>
                </li>
            </ul>
        </div>
    </div>   
  </nav>

  <!-- Notifications Modal -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Sample notification content -->
          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-success">Welcome, Tenant!</h6>
            <p class="mb-0">This is the content of the first notification. You can provide more details here.</p>
          </div>

          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-warning">Maintenance Request</h6>
            <p class="mb-0">The maintenance request you submitted on 12/9/2023, 8:46:24 AM has been resolved.</p>
          </div>

          <!-- Add more notifications as needed -->
        </div>
      </div>
    </div>
  </div>

<!-- Spinner container -->
<div id="logoutSpinnerContainer" class="position-fixed top-50 start-50 translate-middle" style="display: none;">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

  <div class="container mt-5">
      <!-- Payment reminder -->
      <div class="alert alert-info" id="paymentReminder" style="display: none;"></div>

      <h2 class="text-center mb-4">Payment Options</h2>
      <div class="row">
          <div class="col-md-6">
              <div class="card">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/BDO_Unibank_%28logo%29.svg/1200px-BDO_Unibank_%28logo%29.svg.png" class="card-img-top" alt="BDO Bank">
                  <div class="card-body">
                      <h5 class="card-title">BDO Bank</h5>
                      <p class="card-text">Pay Through BDO Bank</p>
                      <p class="card-text">Account Name: MegaPines Realty and <br>Development Inc.</p>
                      <p class="card-text">Account Number: 005470412009</p>
                  </div>
              </div>
          </div>

          <div class="col-md-6">
              <div class="card">
                  <img src="https://upload.wikimedia.org/wikipedia/en/thumb/c/c2/Bank_of_the_Philippine_Islands_logo.svg/1200px-Bank_of_the_Philippine_Islands_logo.svg.png" class="card-img-top" alt="BPI Bank">
                  <div class="card-body">
                      <h5 class="card-title">BPI Bank </h5>
                      <p class="card-text">Pay Through BPI Bank</p>
                      <p class="card-text">Account Name: MegaPines Realty and <br>Development Inc.</p>
                      <p class="card-text">Account Number: 0573350294</p>
                  </div>
              </div>
          </div>
      </div>
      <!-- Submit Button for Proof of Payment -->
      <div class="text-center mt-4">
        <button id="proofOfPaymentSubmit" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#proofOfPaymentModal">Submit Proof of Payment</button>
      </div>
      </div>
    </div>
  </div>

  <!-- Proof of Payment Modal -->
<div class="modal fade" id="proofOfPaymentModal" tabindex="-1" aria-labelledby="proofOfPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="proofOfPaymentModalLabel">Submit Proof of Payment</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <!-- Proof of Payment Form -->
              <form id="proofOfPaymentForm">
                  <div class="mb-3">
                      <label for="proofFile" class="form-label">Select File:</label>
                      <input type="file" class="form-control" id="proofFile" required>
                  </div>
                  <div class="mb-3">
                      <label for="paymentDescription" class="form-label">Description:</label>
                      <textarea class="form-control" id="paymentDescription" rows="3"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Submit</button>
              </form>
          </div>
      </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK script -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

<script src="script.js"></script>

<script>
  const database = firebase.database();
  const auth = firebase.auth();

  // Function to fetch current user and display payment reminder
function displayPaymentReminder() {
    auth.onAuthStateChanged(function(user) {
        if (user) {
            const userId = user.uid;
            const userRef = database.ref('users').child(userId);
            userRef.once('value')
                .then((snapshot) => {
                    const user = snapshot.val();
                    const paymentDate = user.paymentDate;
                    if (paymentDate) {
                        // Calculate next payment date (assuming monthly payments)
                        const currentDate = new Date();
                        const [paymentYear, paymentMonth, paymentDay] = paymentDate.split('-').map(Number);
                        let nextPaymentDate = new Date(paymentYear, paymentMonth - 1, paymentDay); // Subtract 1 from month to adjust to JavaScript's 0-indexed months

                        // If payment date has already passed this month, set next payment date to the same day of the next month
                        if (currentDate.getDate() >= paymentDay) {
                            nextPaymentDate.setMonth(nextPaymentDate.getMonth());
                        }

                        // Display payment reminder
                        const daysUntilPayment = Math.ceil((nextPaymentDate - currentDate) / (1000 * 60 * 60 * 24));
                        document.getElementById('paymentReminder').innerHTML = `Your next payment is due on ${nextPaymentDate.toDateString()}. ${daysUntilPayment} days left.`;
                        document.getElementById('paymentReminder').style.display = 'block';
                    } else {
                        document.getElementById('paymentReminder').innerHTML = 'Payment details not found.';
                        document.getElementById('paymentReminder').classList.add('alert-warning');
                        document.getElementById('paymentReminder').style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error('Error fetching user:', error);
                    document.getElementById('paymentReminder').innerHTML = 'Error fetching user information.';
                    document.getElementById('paymentReminder').classList.add('alert-danger');
                    document.getElementById('paymentReminder').style.display = 'block';
                });
        } else {
            console.log('No user logged in.');
        }
    });
}


  // Call the displayPaymentReminder function when the page loads
  window.onload = displayPaymentReminder;
</script>

<script>
    function logout() {
        // Show the spinner container
        document.getElementById('logoutSpinnerContainer').style.display = 'block';

        // Disable the logout link to prevent multiple clicks
        document.querySelector('.nav-link.text-light').setAttribute('disabled', 'disabled');
        
        firebase.auth().signOut().then(function() {
            // Sign-out successful, redirect to index.html
            window.location.href = 'index.html';
        }).catch(function(error) {
            // An error happened.
            console.error("Logout Error: ", error);
            // If there's an error, reset the UI elements
            document.getElementById('logoutSpinnerContainer').style.display = 'none';
            document.querySelector('.nav-link.text-light').removeAttribute('disabled');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const database = firebase.database();

        // Function to handle form submission for proof of payment
        document.getElementById('proofOfPaymentForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent form submission

            // Get the current user
            const user = firebase.auth().currentUser;

            // Get the file and description input values
            const file = document.getElementById('proofFile').files[0];
            const description = document.getElementById('paymentDescription').value;

            // Check if a file is selected
            if (!file) {
                alert('Please select a file.');
                return;
            }

            // Create a storage reference with a unique filename
            const storageRef = firebase.storage().ref().child(`proofs/${file.name}`);

            // Upload the file to Firebase Storage
            storageRef.put(file).then(function(snapshot) {
                console.log('File uploaded:', snapshot);

                // Get the download URL of the uploaded file
                snapshot.ref.getDownloadURL().then(function(downloadURL) {
                    console.log('File download URL:', downloadURL);

                    // Get the current timestamp
                    const timestamp = Date.now();

                    // Push proof of payment information directly into the "proofs" folder
                    database.ref('proofs').push({
                        userId: user.uid,
                        downloadURL: downloadURL,
                        description: description,
                        timestamp: timestamp
                    }).then(function() {
                        alert('Proof of payment submitted successfully.');
                        // Reset the form
                        document.getElementById('proofOfPaymentForm').reset();
                        // Close the modal
                        const modal = new bootstrap.Modal(document.getElementById('proofOfPaymentModal'));
                        modal.hide();

                        // Push notification to adminNotifications
                        database.ref('adminNotifications').push({
                            isRead: false,
                            message: "A new proof of payment has been submitted. Check payments page.",
                            submittedAt: new Date().toISOString(), // Use current time as submittedAt
                            type: "payment"
                        });
                    }).catch(function(error) {
                        console.error('Error updating database:', error);
                        alert('An error occurred. Please try again.');
                    });
                }).catch(function(error) {
                    console.error('Error getting download URL:', error);
                    alert('An error occurred. Please try again.');
                });
            }).catch(function(error) {
                console.error('Error uploading file:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
  </script>

</body>
</html>
