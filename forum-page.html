<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="x-icon" href="src/megatower-hub-iconx.png">
  <title>Community Forum</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Start of Async Drift Code -->
  <script>
    "use strict";
    
    !function() {
      var t = window.driftt = window.drift = window.driftt || [];
      if (!t.init) {
        if (t.invoked) return void (window.console && console.error && console.error("Drift snippet included twice."));
        t.invoked = !0, t.methods = [ "identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on" ], 
        t.factory = function(e) {
          return function() {
            var n = Array.prototype.slice.call(arguments);
            return n.unshift(e), t.push(n), t;
          };
        }, t.methods.forEach(function(e) {
          t[e] = t.factory(e);
        }), t.load = function(t) {
          var e = 3e5, n = Math.ceil(new Date() / e) * e, o = document.createElement("script");
          o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js";
          var i = document.getElementsByTagName("script")[0];
          i.parentNode.insertBefore(o, i);
        };
      }
    }();
    drift.SNIPPET_VERSION = '0.3.1';
    drift.load('kin4c3m7twpw');
    </script>
    <!-- End of Async Drift Code -->
</head>
<body>

  <!--Navbar-->
  <nav class="navbar navbar-expand-lg bg-success navbar-dark fixed-top">
    <div class="container">
      <a href="home-page.html" class="navbar-brand">
        <img src="src/megatower-hub-icon.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top me-2">
        MegaTower Hub
      </a>

        <button class="navbar-toggler" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#navmenu" 
            aria-controls="navmenu" 
            aria-expanded="false" 
            aria-label="Toggle navigation menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navmenu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                  <button type="button" class="nav-link text-light btn" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    Notifications <span id="unreadCountBadge" class="badge bg-danger">0</span>
                  </button>
                </li>
                <li class="nav-item">
                    <a href="complain-page.html" class="nav-link text-light">Complaints</a>
                </li>
                <li class="nav-item">
                    <a href="request-page.html" class="nav-link text-light">Request</a>
                </li>
                <li class="nav-item">
                    <a href="payment-page.html" class="nav-link text-light">Payment</a>
                </li>
                <li class="nav-item">
                    <a href="forum-page.html" class="nav-link text-light">Forum</a>
                </li>
                <li class="nav-item">
                    <a href="tenant-profile.html" class="nav-link text-light">Profile</a>
                </li>
                <li class="nav-item">
                    <a href="javascript:void(0);" onclick="logout()" class="nav-link text-light">Logout</a>
                </li>
            </ul>
        </div>
    </div>   
  </nav>

  <!-- Notifications Modal -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Sample notification content -->
          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-success">Welcome, Tenant!</h6>
            <p class="mb-0">This is the content of the first notification. You can provide more details here.</p>
          </div>

          <div class="notification mb-4 p-3 border rounded">
            <h6 class="text-warning">Maintenance Request</h6>
            <p class="mb-0">The maintenance request you submitted on 12/9/2023, 8:46:24 AM has been resolved.</p>
          </div>

          <!-- Add more notifications as needed -->
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-5">
    <h3>Community Forum</h3>

    <!-- Search Bar -->
    <div class="input-group mt-3 mb-3">
      <input type="text" class="form-control" id="searchInput" placeholder="Search discussions or tags">
      <button class="btn btn-outline-primary" type="button" id="searchButton">Search</button>
    </div>
  
    <!-- Box for "Create Discussion" button -->
    <div class="card mt-4">
      <div class="card-body">
        <button type="button" class="btn btn-primary" id="toggleDiscussionForm">Create Discussion</button>
  
        <!-- Form for creating discussions -->
        <form id="discussionForm" class="mt-4" style="display: none;">
          <div class="mb-3">
            <label for="discussionTitle" class="form-label">Discussion Title</label>
            <input type="text" class="form-control" id="discussionTitle" required>
          </div>
          <div class="mb-3">
            <label for="discussionContent" class="form-label">Discussion Content</label>
            <textarea class="form-control" id="discussionContent" rows="5" required></textarea>
          </div>
          <div class="mb-3">
            <label for="discussionTags" class="form-label">Tags/Keywords</label>
            <input type="text" class="form-control" id="discussionTags" placeholder="Separate tags with commas">
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  
    <!-- Recent discussions section -->
    <div class="mt-5">
      <h4>Recent Discussions</h4>
      <div id="recentDiscussions"></div>
    </div>
  </div>  

    <!-- Spinner container -->
    <div id="logoutSpinnerContainer" class="position-fixed top-50 start-50 translate-middle" style="display: none;">
      <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  <!-- jQuery library -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase JavaScript SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>

  <script src="script.js"></script>

  <script>
    // Reference to the Firebase Realtime Database
    var database = firebase.database();

  // Function to fetch recent discussions
  function fetchRecentDiscussions() {
    database.ref('discussions').orderByChild('timestamp').limitToLast(10).once('value', function(snapshot) {
      var recentDiscussionsDiv = document.getElementById('recentDiscussions');
      recentDiscussionsDiv.innerHTML = ''; // Clear previous discussions
      var promises = []; // Array to hold promises for fetching author names
      snapshot.forEach(function(childSnapshot) {
        var postData = childSnapshot.val();
        var authorUID = postData.authorUID; // Retrieve the author's UID

        // Fetch author's full name from the database
        var promise = database.ref('users/' + authorUID + '/fullName').once('value').then(function(snapshot) {
          var authorName = snapshot.val(); // Retrieve author's full name

          return { postData: postData, authorName: authorName }; // Return an object with postData and authorName
        }).catch(function(error) {
          console.error('Error fetching user data:', error.message);
          return null; // Return null if there's an error
        });

        promises.push(promise); // Add the promise to the promises array
      });

      // Wait for all promises to resolve
      Promise.all(promises).then(function(results) {
        // Filter out any null results (i.e., if there was an error fetching user data)
        results = results.filter(function(result) {
          return result !== null;
        });

        // Iterate through results in reverse order and append discussion HTML to recentDiscussionsDiv
        for (var i = results.length - 1; i >= 0; i--) {
          var result = results[i];
          var postData = result.postData;
          var authorName = result.authorName;
          var postKey = postData.key; // Retrieve the post key

          // Append discussion post to the recentDiscussions div
          var discussionHTML = `
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">${postData.title}</h5>
              <p class="card-text">${postData.content}</p>
              <small class="text-muted">Posted by ${authorName === firebase.auth().currentUser.displayName ? 'You' : authorName} on ${new Date(postData.timestamp).toLocaleString()}</small>
              
              <!-- Tags section -->
              <div class="mt-3">
                ${postData.tags.map(tag => `<span class="badge bg-secondary rounded-pill">${tag}</span>`).join(' ')}
              </div>
              
              <!-- Upvote and downvote buttons with vote counts -->
              <div class="mt-3">
                <button class="btn btn-link" onclick="upvote('${postKey}')"><i class="bi bi-arrow-up"></i></button>
                <span id="upvoteCount-${postKey}">${postData.upvotes || 0}</span>
                <button class="btn btn-link" onclick="downvote('${postKey}')"><i class="bi bi-arrow-down"></i></button>
                <span id="downvoteCount-${postKey}">${postData.downvotes || 0}</span>
                <button class="btn btn-link" onclick="toggleCommentInput('${postKey}')">Comment</button>
              </div>
              
              <!-- Comment section -->
              <div id="commentSection-${postKey}" class="mt-3" style="display: none;">
                <input type="text" class="form-control" id="commentInput-${postKey}" placeholder="Write a comment">
                <button class="btn btn-primary mt-2" onclick="postComment('${postKey}')">Post Comment</button>
              </div>
              
              <!-- Comments -->
              <div id="comments-${postKey}" class="mt-3">
                <!-- Comments will be displayed here -->
              </div>
            </div>
          </div>`;
          recentDiscussionsDiv.innerHTML += discussionHTML;
          // Fetch and display comments for this discussion
          fetchComments(postKey);
        }
      });
    });
  }

    // Function to handle discussion form submission
    document.getElementById('discussionForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent default form submission

      // Get form values
      var title = document.getElementById('discussionTitle').value;
      var content = document.getElementById('discussionContent').value;
      var tags = document.getElementById('discussionTags').value.split(',').map(tag => tag.trim());
      var authorUID = firebase.auth().currentUser.uid; // Get current user's UID

      // Add current timestamp to discussion data
      var timestamp = new Date().toISOString();

      // Add discussion to Firebase
      var newDiscussionRef = database.ref('discussions').push();
      var discussionKey = newDiscussionRef.key; // Get the key of the newly added discussion
      newDiscussionRef.set({
        title: title,
        content: content,
        tags: tags,
        authorUID: authorUID,
        timestamp: timestamp
      });

      // Reset form
      document.getElementById('discussionForm').reset();
    });

    // Function to handle toggling the discussion form visibility
    document.getElementById('toggleDiscussionForm').addEventListener('click', function() {
      var discussionForm = document.getElementById('discussionForm');
      var toggleButton = document.getElementById('toggleDiscussionForm');
      // Toggle the display of the discussion form
      if (discussionForm.style.display === 'none') {
        discussionForm.style.display = 'block';
        toggleButton.innerText = 'Cancel';
      } else {
        discussionForm.style.display = 'none';
        toggleButton.innerText = 'Create Discussion';
      }
    });

    // Function to toggle comment input visibility
    function toggleCommentInput(postKey) {
      var commentSection = document.getElementById('commentSection-' + postKey);
      if (commentSection.style.display === 'none') {
        commentSection.style.display = 'block';
      } else {
        commentSection.style.display = 'none';
      }
    }

    // Function to post a comment
    function postComment(postKey) {
      var commentInput = document.getElementById('commentInput-' + postKey);
      var commentText = commentInput.value.trim();
      if (commentText !== '') {
        var authorUID = firebase.auth().currentUser.uid; // Get current user's UID

        // Fetch author's full name from the database
        database.ref('users/' + authorUID + '/fullName').once('value').then(function(snapshot) {
          var authorName = snapshot.val(); // Retrieve author's full name

          var commentRef = database.ref('comments/' + postKey).push();
          commentRef.set({
            authorUID: authorUID,
            authorName: authorName,
            text: commentText
          });
          // Clear comment input after posting
          commentInput.value = '';
        }).catch(function(error) {
          console.error('Error fetching user data:', error.message);
        });
      }
    }

    // Function to fetch and display comments for a given discussion post
    function fetchComments(postKey) {
      var commentsDiv = document.getElementById('comments-' + postKey);
      commentsDiv.innerHTML = ''; // Clear previous comments

      // Reference to the comments for the given discussion post
      var commentsRef = database.ref('comments/' + postKey);
      
      // Fetch comments from the database
      commentsRef.on('child_added', function(snapshot) {
        var commentData = snapshot.val();
        var commentAuthorName = commentData.authorName;
        var commentText = commentData.text;

        // Create HTML for the comment
        var commentHTML = `
          <div class="card mt-3">
            <div class="card-body">
              <p class="card-text">${commentText}</p>
              <small class="text-muted">Comment by ${commentAuthorName}</small>
            </div>
          </div>`;

        // Append the comment HTML to the commentsDiv
        commentsDiv.innerHTML += commentHTML;
      });
    }

    // Function to handle upvoting a post
    function upvote(postKey) {
      var user = firebase.auth().currentUser;
      if (user) {
        var userId = user.uid;
        var postRef = database.ref('discussions/' + postKey);

        postRef.once('value').then(function(snapshot) {
          var post = snapshot.val();
          if (!post.upvoters) {
            post.upvoters = {};
          }
          if (post.upvoters[userId]) {
            // Remove upvote
            post.upvotes -= 1;
            delete post.upvoters[userId];
          } else {
            // Add upvote
            post.upvotes = (post.upvotes || 0) + 1;
            post.upvoters[userId] = true;

            // Check if user has already downvoted, remove downvote if yes
            if (post.downvoters && post.downvoters[userId]) {
              post.downvotes -= 1;
              delete post.downvoters[userId];
            }
          }
          postRef.update(post);
        });
      } else {
        console.log("You need to be logged in to upvote.");
      }
    }

    // Function to handle downvoting a post
    function downvote(postKey) {
      var user = firebase.auth().currentUser;
      if (user) {
        var userId = user.uid;
        var postRef = database.ref('discussions/' + postKey);

        postRef.once('value').then(function(snapshot) {
          var post = snapshot.val();
          if (!post.downvoters) {
            post.downvoters = {};
          }
          if (post.downvoters[userId]) {
            // Remove downvote
            post.downvotes -= 1;
            delete post.downvoters[userId];
          } else {
            // Add downvote
            post.downvotes = (post.downvotes || 0) + 1;
            post.downvoters[userId] = true;

            // Check if user has already upvoted, remove upvote if yes
            if (post.upvoters && post.upvoters[userId]) {
              post.upvotes -= 1;
              delete post.upvoters[userId];
            }
          }
          postRef.update(post);
        });
      } else {
        console.log("You need to be logged in to downvote.");
      }
    }

    // Function to handle Firebase Authentication state changes
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in
        // Display username or any other information if needed
        console.log('User is signed in:', user.displayName);
      } else {
        // User is signed out
        // Redirect or handle accordingly
        console.log('User is signed out');
      }
    });

    // Call fetchRecentDiscussions when the page loads
    window.onload = function() {
      fetchRecentDiscussions();
    };

    // Function to handle search
    document.getElementById('searchButton').addEventListener('click', function() {
        var searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
        if (searchInput !== '') {
            searchDiscussions(searchInput);
        } else {
            // If search input is empty, display all recent discussions
            fetchRecentDiscussions();
        }
    });

    // Function to search discussions and tags
    function searchDiscussions(searchInput) {
        database.ref('discussions').once('value', function(snapshot) {
            var matchingDiscussions = [];
            snapshot.forEach(function(childSnapshot) {
                var postData = childSnapshot.val();
                var postTitle = postData.title.toLowerCase();
                var postContent = postData.content.toLowerCase();
                var postTags = postData.tags.join(',').toLowerCase();
                if (postTitle.includes(searchInput) || postContent.includes(searchInput) || postTags.includes(searchInput)) {
                    matchingDiscussions.push(postData);
                }
            });
            displayMatchingDiscussions(matchingDiscussions);
        });
    }

    // Function to display matching discussions after search
    function displayMatchingDiscussions(matchingDiscussions) {
        var recentDiscussionsDiv = document.getElementById('recentDiscussions');
        recentDiscussionsDiv.innerHTML = ''; // Clear previous discussions
        matchingDiscussions.forEach(function(postData) {
            var postKey = postData.key; // Retrieve the post key

            // Append discussion post to the recentDiscussions div
            var discussionHTML = `
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">${postData.title}</h5>
                <p class="card-text">${postData.content}</p>
                <small class="text-muted">Posted by ${postData.authorUID === firebase.auth().currentUser.uid ? 'You' : postData.authorUID ? postData.fullName || 'Unknown' : 'Unknown'} on ${new Date(postData.timestamp).toLocaleString()}</small>
                
                <!-- Tags section -->
                <div class="mt-3">
                  ${postData.tags.map(tag => `<span class="badge bg-secondary rounded-pill">${tag}</span>`).join(' ')}
                </div>
                
                <!-- Upvote and downvote buttons with vote counts -->
                <div class="mt-3">
                  <button class="btn btn-link" onclick="upvote('${postKey}')"><i class="bi bi-arrow-up"></i></button>
                  <span id="upvoteCount-${postKey}">${postData.upvotes || 0}</span>
                  <button class="btn btn-link" onclick="downvote('${postKey}')"><i class="bi bi-arrow-down"></i></button>
                  <span id="downvoteCount-${postKey}">${postData.downvotes || 0}</span>
                  <button class="btn btn-link" onclick="toggleCommentInput('${postKey}')">Comment</button>
                </div>
                
                <!-- Comment section -->
                <div id="commentSection-${postKey}" class="mt-3" style="display: none;">
                  <input type="text" class="form-control" id="commentInput-${postKey}" placeholder="Write a comment">
                  <button class="btn btn-primary mt-2" onclick="postComment('${postKey}')">Post Comment</button>
                </div>
                
                <!-- Comments -->
                <div id="comments-${postKey}" class="mt-3">
                  <!-- Comments will be displayed here -->
                </div>
              </div>
            </div>`;
            recentDiscussionsDiv.innerHTML += discussionHTML;
            // Fetch and display comments for this discussion
            fetchComments(postKey);
        });
    }
  </script>

  <script>
    function logout() {
        // Show the spinner container
        document.getElementById('logoutSpinnerContainer').style.display = 'block';

        // Disable the logout link to prevent multiple clicks
        document.querySelector('.nav-link.text-light').setAttribute('disabled', 'disabled');
        
        firebase.auth().signOut().then(function() {
            // Sign-out successful, redirect to index.html
            window.location.href = 'index.html';
        }).catch(function(error) {
            // An error happened.
            console.error("Logout Error: ", error);
            // If there's an error, reset the UI elements
            document.getElementById('logoutSpinnerContainer').style.display = 'none';
            document.querySelector('.nav-link.text-light').removeAttribute('disabled');
        });
    }
  </script>
</body>
</html>